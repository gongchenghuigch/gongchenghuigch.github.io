<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="webpack浅入深出, gongchenghui,github">
    <meta name="description" content="
基础知识回顾
入口(entry)
module.exports = {
  entry: &#39;./path/to/my/entry/file.js&#39;
};
//或者
module.exports = {
  entry: {
    mai">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>webpack浅入深出 | gongchenghui</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">gongchenghui</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>主页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-rocket"></i>
            
            <span>工具</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">gongchenghui</div>
        <div class="logo-desc">
            
            北冥有鱼，其名为鲲，鲲之大，不知其几千里也； 化而为鸟，其名为鹏.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                主页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-rocket"></i>
                
                工具
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/gongchenghuigch/gongchenghuigch.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/gongchenghuigch/gongchenghuigch.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/18.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        webpack浅入深出
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/webpack/" target="_blank">
                                <span class="chip bg-color">webpack</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/大前端/" class="post-category" target="_blank">
                                大前端
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-02-02
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.9k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        36 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn22y1ijztj30uf0ccdh6.jpg" alt="image-20210127111317254"></p>
<h2 id="基础知识回顾"><a href="#基础知识回顾" class="headerlink" title="基础知识回顾"></a>基础知识回顾</h2><ul>
<li><p><a href="https://webpack.docschina.org/concepts/#entry" target="_blank" rel="noopener">入口(entry)</a></p>
<pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token string">'./path/to/my/entry/file.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//或者</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    main<span class="token punctuation">:</span> <span class="token string">'./path/to/my/entry/file.js'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<ul>
<li><p><a href="https://webpack.docschina.org/concepts/#output" target="_blank" rel="noopener">输出(output)</a></p>
<pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span><span class="token string">'[name][chunkhash:8].js'</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><a href="https://webpack.docschina.org/concepts/#loaders" target="_blank" rel="noopener">loader</a><br><strong>预处理loader</strong>  </p>
<ul>
<li>css-loader 处理css中路径引用等问题</li>
<li>style-loader 动态把样式写入css</li>
<li>sass-loader scss编译器</li>
<li>less-loader less编译器</li>
<li>postcss-loader scss再处理  </li>
</ul>
<p><strong>处理js loader</strong>  </p>
<ul>
<li>babel-loader</li>
<li>jsx-loader</li>
<li>ts-loader</li>
</ul>
<p><strong>图片处理loader</strong></p>
<ul>
<li>url-loader</li>
</ul>
</li>
<li><p><a href="https://webpack.docschina.org/concepts/#plugins" target="_blank" rel="noopener">插件(plugin)</a><br><code>plugins</code>里面放的是插件，插件的作用在于提高开发效率，能够解放双手，让我们去做更多有意义的事情。一些很low的事就统统交给插件去完成。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token comment" spellcheck="true">//清除文件</span>
        <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//css单独打包</span>
        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            filename<span class="token punctuation">:</span> <span class="token string">"[name].css"</span><span class="token punctuation">,</span>
            chunkFilename<span class="token punctuation">:</span> <span class="token string">"[name].css"</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 引入热更新插件</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><a href="https://webpack.docschina.org/concepts/#mode" target="_blank" rel="noopener">模式(mode)</a></p>
<ul>
<li>production 生产环境</li>
</ul>
</li>
<li><p>development 开发环境</p>
<ul>
<li>提升了构建速度</li>
<li>默认为开发环境，不需要专门配置</li>
<li>提供压缩功能，不需要借助插件</li>
<li>提供<code>SouceMap</code>，不需要专门配置</li>
</ul>
</li>
<li><p><a href="https://webpack.docschina.org/concepts/#browser-compatibility" target="_blank" rel="noopener">浏览器兼容性(browser compatibility)</a></p>
</li>
<li><p><a href="https://webpack.docschina.org/concepts/#environment" target="_blank" rel="noopener">环境(environment)</a></p>
</li>
</ul>
<p><a href="https://segmentfault.com/a/1190000019998714" target="_blank" rel="noopener">项目中详细配置</a></p>
<h2 id="构建过程"><a href="#构建过程" class="headerlink" title="构建过程"></a>构建过程</h2><p>Webpack 处理应用程序时，它会递归地构建一个依赖关系图(<code>dependency graph</code>)，其中包含应用程序需要的每个模块，然后将所有模块打包成一个或多个 <code>bundle</code></p>
<p>其实就是：Webpack 是一个 JS 代码打包器。</p>
<p>至于图片、CSS、Less、TS等其他文件，就需要 Webpack 配合 loader 或者 plugin 功能来实现。</p>
<h3 id="构建流程"><a href="#构建流程" class="headerlink" title="构建流程"></a>构建流程</h3><ol>
<li>根据配置，识别入口文件；</li>
<li>逐层识别模块依赖（包括 Commonjs、AMD、或 ES6 的 import 等，都会被识别和分析）；</li>
<li>Webpack 主要工作内容就是分析代码，转换代码，编译代码，最后输出代码；</li>
<li>输出最后打包后的代码。</li>
</ol>
<p>webpack构建的三个阶段： </p>
<ol>
<li>初始化阶段</li>
<li>编译阶段</li>
<li>输出阶段 </li>
</ol>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><ul>
<li><p>初始化参数: 从配置文件和 Shell 语句中读取与合并参数，得出最终的参数。这个过程中还会执行配置文件中的插件实例化语句 new Plugin()。</p>
</li>
<li><p>初始化默认参数配置: new WebpackOptionsDefaulter().process(options)</p>
</li>
<li><p>实例化Compiler对象:用上一步得到的参数初始化Compiler实例，Compiler负责文件监听和启动编译。Compiler实例中包含了完整的Webpack配置，全局只有一个Compiler实例。</p>
</li>
<li><p>加载插件: 依次调用插件的apply方法，让插件可以监听后续的所有事件节点。同时给插件传入compiler实例的引用，以方便插件通过compiler调用Webpack提供的API。</p>
</li>
<li><p>处理入口: 读取配置的Entrys，为每个Entry实例化一个对应的EntryPlugin，为后面该Entry的递归解析工作做准备</p>
</li>
</ul>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><h4 id="1、生成chunk"><a href="#1、生成chunk" class="headerlink" title="1、生成chunk"></a>1、生成chunk</h4><p>chunk是webpack内部运行时的概念；一个chunk是对依赖图的部分进行封装的结果（``Chunk<code>the class is the encapsulation for parts of your dependency graph</code>）；可以通过多个entry-point来生成一个chunk<br>chunk可以分为三类;</p>
<ul>
<li>entry chunk<ul>
<li>包含webpack runtime code并且是最先执行的chunk</li>
</ul>
</li>
<li>initial chunk<ul>
<li>包含同步加载进来的module且不包含runtime code的chunk</li>
<li>在entry chunk执行后再执行的</li>
</ul>
</li>
<li>normal chunk<ul>
<li>使用<code>require.ensure</code>、<code>System.import</code>、<code>import()</code>异步加载进来的<code>module</code>，会被放到normal chunk中</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn2d2eegeaj30ps0fkgm8.jpg" alt="image-20210127170328144" style="zoom:50%;">  

<p>每个chunk都至少有一个属性：</p>
<ul>
<li>name: 默认为main</li>
<li>id: 唯一的编号，开发环境和name相同，生产环境是一个数字，从0开始</li>
</ul>
<h4 id="2、构建依赖模块"><a href="#2、构建依赖模块" class="headerlink" title="2、构建依赖模块"></a>2、构建依赖模块</h4><blockquote>
<p>var compiler = webpack(options);</p>
</blockquote>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1594808617828.52.36.png" alt="屏幕快照 2020-07-15 15.52.36.png"></p>
<p>从入口文件index.js开始分析，检查右侧表格中的记录，如果有记录就结束。没有记录就继续读取文件内容，读取完文件内容后，开始进行抽象树语法分析，将代码字符串转换成一个对象的描述文件。并将其中的依赖保存在dependencies数组中</p>
<pre class="line-numbers language-js"><code class="language-js">dependencies：<span class="token punctuation">[</span><span class="token string">"./src/a.js"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>保存完以后，替换依赖函数</p>
<pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"index.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">_webpack_reuqire</span><span class="token punctuation">(</span><span class="token string">"./src/a.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>将转换后的代码字符串保存在右侧的表格中</p>
<table>
<thead>
<tr>
<th>模块id</th>
<th>转换后的代码</th>
</tr>
</thead>
<tbody><tr>
<td>./src/index.js</td>
<td>console.log(“index.js”);_webpack_reuqire(“./src/a.js”);</td>
</tr>
</tbody></table>
<p>因为dependencies中有数据，开始递归解析dependencies中的数据。取出.src/a.js</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// .src/a.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"a.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看右侧表格，发现没有a.js，开始读取文件内容，生成ast抽象语法树，将依赖记录在数组中</p>
<pre class="line-numbers language-js"><code class="language-js">dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"./src/b.js"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后替换函数依赖</p>
<pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"a.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">_webpack_require</span><span class="token punctuation">(</span><span class="token string">"./src/b.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">"a"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>将转换后的代码记录在右侧的表格中</p>
<table>
<thead>
<tr>
<th>模块id</th>
<th>转换后的代码</th>
</tr>
</thead>
<tbody><tr>
<td>./src/index.js</td>
<td>console.log(“index.js”);_webpack_reuqire(“./src/a.js”);</td>
</tr>
<tr>
<td>./src/a.js</td>
<td>console.log(“a.js”);_webpack_require(“./src/b.js”);module.exports = “a”</td>
</tr>
</tbody></table>
<p>然后继续取出来dependencies的内容./src/b.js</p>
<pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"b.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">"b"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>发现右侧表格中没有b.js这个文件，就继续读取文件内容，进行ast抽象语法树分析，发现没有依赖项，就不需要往数组中放东西，也不需要替换依赖项，将代码字符串存在表格中</p>
<table>
<thead>
<tr>
<th>模块id</th>
<th>转换后的代码</th>
</tr>
</thead>
<tbody><tr>
<td>./src/index.js</td>
<td>console.log(“index.js”);_webpack_reuqire(“./src/a.js”);</td>
</tr>
<tr>
<td>./src/a.js</td>
<td>console.log(“a.js”);_webpack_require(“./src/b.js”);module.exports = “a”</td>
</tr>
<tr>
<td>./src/b.js</td>
<td>console.log(“b.js”);module.exports = “b”;</td>
</tr>
</tbody></table>
<p>然后递归回去，发现index下产生的数组是空，整个文件依赖就解析完毕</p>
<h4 id="3、产生chunk-assets"><a href="#3、产生chunk-assets" class="headerlink" title="3、产生chunk assets"></a>3、产生chunk assets</h4><p>在第二步完成以后，chunk中会产生一个模块列表，列表中包含了<strong>模块id</strong>和<strong>模块转换后的代码</strong></p>
<p>接下来，webpack会根据配置为chunk生成一个<strong>资源列表</strong>，即<code>chunk assets</code>,资源列表可以理解为是生成到最终文件的文件名和文件内容</p>
<ul>
<li>为什么叫资源列表呢？</li>
<li>因为有可能配置devtool生成的除了./dist/main.js还有./dist/main.js.map</li>
</ul>
<p>即：文件名：./dist/main.js</p>
<p>文件内容：</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//是否是eval可以根据devtool来设置，有很多种方式</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"console.log(\"index module\");\nvar a = __webpack_require__(/*! ./a */ \"./src/a.js\"); \na.abc();\nconsole.log(a);\n\n\n//# sourceURL=webpack:///./src/index.js?"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1594808697230.04.09.png" alt="屏幕快照 2020-07-15 17.04.09.png"></p>
<blockquote>
<p>chunk hash: 是根据所有的chunk assets的内容生成的一个hash字符串<br>hash: 一种算法，具有很多分类。特点是将一个任意长度的字符串转换成一个固定长度的字符串，而且可以保证原始内容不变</p>
</blockquote>
<p>就是将我们上面生成的文件内容，全部联合起来，然后生成一个固定长度的哈希值链接</p>
<p>简图： <img src="https://img.58cdn.com.cn/escstatic/docs/images/1594808723385.13.36.png" alt="屏幕快照 2020-07-15 17.13.36.png"></p>
<p>多个chunk assets就是一个bundle（一捆）</p>
<h4 id="4、合并chunk-assets"><a href="#4、合并chunk-assets" class="headerlink" title="4、合并chunk assets"></a>4、合并chunk assets</h4><p>将多个chunk的assets合并到一起，并产生一个总的hash <img src="https://img.58cdn.com.cn/escstatic/docs/images/1594808750383.16.11.png" alt="屏幕快照 2020-07-15 17.16.11.png"></p>
<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><p>webpack将利用node中的fs模块（文件处理模块），根据编译产生的总的assets，生成相应的文件</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1594804932479.22.03.png" alt="屏幕快照 2020-07-15 17.22.03.png"></p>
<h3 id="涉及术语"><a href="#涉及术语" class="headerlink" title="涉及术语"></a>涉及术语</h3><ol>
<li>module: 模块，分割的代码单元，webpack中的模块可以是任何内容的文件，不仅限于JS</li>
<li>chunk: webpack内部构建模块的块，一个chunk中包含多个模块，这些模块是从入口模块通过依赖分析得来的</li>
<li>bundle：chunk构建好模块后会生成chunk的资源清单，清单中的每一项就是一个bundle，可以认为bundle就是最终生成的文件</li>
<li>hash：最终的资源清单所有内容联合生成的hash值</li>
<li>chunkhash: chunk生成的资源清单内容联合生成的hash值</li>
<li>chunkname：chunk的名称，如果没有配置则使用main</li>
<li>id: 通常指chunk的唯一编号，如果在开发环境下构建，和chunkname相同；如果是生产环境下构建，则使用一个从0开始的数字进行编号</li>
</ol>
<h2 id="HMR热更新原理"><a href="#HMR热更新原理" class="headerlink" title="HMR热更新原理"></a>HMR热更新原理</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Hot Module Replacement（以下简称：HMR 模块热替换）是 Webpack 提供的一个非常有用的功能，<strong>它允许在 JavaScript 运行时更新各种模块，而无需完全刷新</strong>。</p>
<p>当我们修改代码并保存后，Webpack 将对代码重新打包，HMR 会在应用程序运行过程中替换、添加或删除模块，而无需重新加载整个页面。<br>HMR 主要通过以下几种方式，来显著加快开发速度：</p>
<ul>
<li>保留在完全重新加载页面时丢失的应用程序状态；</li>
<li>只更新变更内容，以节省宝贵的开发时间；</li>
<li>调整样式更加快速 - 几乎相当于在浏览器调试器中更改样式。</li>
</ul>
<h3 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h3><p>webpack-dev-server：不是一个插件，而是一个web服务器  </p>
<p><strong>服务启动流程</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3dt3473mj31ld0u0guk.jpg" alt="image-20210128141442540">  </p>
<p><strong>webpack-dev-server源码解析</strong>  </p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//启动服务的具体方法</span>
<span class="token keyword">function</span> <span class="token function">startDevServer</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> log <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//声明全局webpack实例</span>
  <span class="token keyword">let</span> compiler<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">webpack<span class="token punctuation">.</span>WebpackOptionsValidationError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>stats<span class="token punctuation">.</span>colors<span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// eslint-disable-next-line no-process-exit</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//创建server服务</span>
    server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> options<span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    serverData<span class="token punctuation">.</span>server <span class="token operator">=</span> server<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'ValidationError'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>stats<span class="token punctuation">.</span>colors<span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// eslint-disable-next-line no-process-exit</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//设置服务监听</span>
    server<span class="token punctuation">.</span>listeningApp<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'EADDRINUSE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//使用socket建立长连接</span>
        <span class="token comment" spellcheck="true">//初始化socket</span>
        <span class="token keyword">const</span> clientSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">net<span class="token punctuation">.</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        clientSocket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'ECONNREFUSED'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// No other server listening on this socket so it can be safely removed</span>
            fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>

            server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>socket<span class="token punctuation">,</span> options<span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        clientSocket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> options<span class="token punctuation">.</span>socket <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'This socket is already used'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>socket<span class="token punctuation">,</span> options<span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// chmod 666 (rw rw rw)</span>
      <span class="token keyword">const</span> READ_WRITE <span class="token operator">=</span> <span class="token number">438</span><span class="token punctuation">;</span>

      fs<span class="token punctuation">.</span><span class="token function">chmod</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>socket<span class="token punctuation">,</span> READ_WRITE<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>port<span class="token punctuation">,</span> options<span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//启动webpack-dev-server服务器</span>
<span class="token function">processOptions</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">startDevServer</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>server.js源码解析</strong></p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> _log<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment" spellcheck="true">//构造函数初始化服务</span>
  <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//创建初始化express应用</span>
  <span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
     <span class="token comment" spellcheck="true">// 绑定监听事件</span>
  <span class="token function">setupHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//当监听到一次webpack编译结束，就会调用_sendStats方法通过websocket给浏览器发送通知，</span>
    <span class="token comment" spellcheck="true">//ok和hash事件，这样浏览器就可以拿到最新的hash值了，做检查更新逻辑</span>
    <span class="token keyword">const</span> addHooks <span class="token operator">=</span> <span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> compile<span class="token punctuation">,</span> invalid<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">;</span>
      compile<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-server'</span><span class="token punctuation">,</span> invalidPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
      invalid<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-server'</span><span class="token punctuation">,</span> invalidPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 监听webpack的done钩子，tapable提供的监听方法</span>
      done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-server'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>stats<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_sendStats</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//使用webpack-dev-middleware中间件，返回生成的bundle文件</span>
  <span class="token function">setupDevMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// middleware for serving webpack bundle</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">,</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token punctuation">{</span> logLevel<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span>options<span class="token punctuation">.</span>level <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment" spellcheck="true">//创建http服务，并启动服务</span>
  <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//创建socket服务器建立长连接</span>
  <span class="token function">createSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//使用socket在服务器和浏览器直接建立一个websocket长连接</span>
  <span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 通过websoket给客户端发消息</span>
  <span class="token function">_sendStats</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'hash'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'errors'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'warnings'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>warnings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>client/index.js源码解析</strong></p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> onSocketMessage <span class="token operator">=</span> <span class="token punctuation">{</span> 
  hash<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span>_hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 更新currentHash值</span>
        status<span class="token punctuation">.</span>currentHash <span class="token operator">=</span> _hash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    ok<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">'Ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 进行更新检查等操作</span>
        <span class="token function">reloadApp</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// 连接服务地址socketUrl，?http://localhost:8080，本地服务地址</span>
<span class="token function">socket</span><span class="token punctuation">(</span>socketUrl<span class="token punctuation">,</span> onSocketMessage<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h3><h4 id="热更新流程"><a href="#热更新流程" class="headerlink" title="热更新流程"></a>热更新流程</h4><p><img src="https://img.58cdn.com.cn/escstatic/fecar/pmuse/webpackhmr/3id9sie_200629210005.png" alt="webpackHMR流程">  </p>
<ol>
<li>文件系统发生变化</li>
<li>当监听到文件发生变化时，webpack 使用HotModuleReplacementPlugin编译文件，并将代码保存在内存中(webpack-dev-middleware)。</li>
<li>同时，webpack-dev-server通过编译器compiler获得文件的编译情况。</li>
<li>在compiler的 <code>done</code> 钩子函数（生命周期）里调用_sendStats发送向client发送hash值，在client保存下来。</li>
<li>client接收到ok或warning消息后调用<strong>reloadApp</strong>发布客户端检查更新事件webpackHotUpdate。</li>
<li>webpack/hot监听到webpackHotUpdate事件，调用check方法进行hash值对比以及检查各modules是否需要更新。</li>
<li>调用JsonpMainTemplate.runtime的hotDownloadManifest方法向server端发送ajax请求</li>
<li>服务端返回hot-update.json（manifest）文件，该文件包含所有要更新模块的hash值和chunk名。</li>
<li>JsonpRuntime根据返回的json值使用jsonp请求具体的代码块</li>
<li>jsonp返回最新的chunk代码，并直接执行。</li>
<li>HotModulePlugin 将会对新旧模块进行对比，决定是否更新模块，检查模块之间的依赖关系，更新模块的同时更新模块间的依赖引用。</li>
<li>HMR runtime本身并不会处理代码修改，它会将不同文件交给对应的loader runtime处理</li>
<li>更新代码</li>
<li>如果更新失败，则直接刷新</li>
</ol>
<h4 id="webpaserver端源码"><a href="#webpaserver端源码" class="headerlink" title="webpaserver端源码"></a>webpaserver端源码</h4><p>在项目初始化时，服务端与客户端已经开启了长连接服务，当webpack对文件编译产生变化时，服务端会及时通知客户端。</p>
<pre><code>class Server {
  ...
  setupHooks() {
    //添加webpack的done事件回调
    const addHooks = (compiler) =&amp;gt; {
      const { compile, invalid, done } = compiler.hooks;
      //通知正在客户端编译  
      compile.tap(\&#39;webpack-dev-server\&#39;, invalidPlugin);
      done.tap(\&#39;webpack-dev-server\&#39;, (stats) =&amp;gt; {
        //编译完成向客户端发送消息
        this._sendStats(this.sockets, this.getStats(stats)); 
        this._stats = stats;
      });
    };
    addHooks(this.compiler);
  } 
  _sendStats(sockets, stats, force) {
    if (...) { //无变化则return
      return this.sockWrite(sockets, \&#39;still-ok\&#39;);
    }
    //如果有变化，则发送hash值
    this.sockWrite(sockets, \&#39;hash\&#39;, stats.hash);

    if (stats.errors.length &amp;gt; 0) {
      this.sockWrite(sockets, \&#39;errors\&#39;, stats.errors);
    } else {//没有报错发送ok
      this.sockWrite(sockets, \&#39;ok\&#39;);
    }
  }
  ...
  //使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接
  listen(port, hostname, fn) {...}
}</code></pre><p>这里仍然是Server.js中的代码，我详细的写展示了setupHooks中的代码，setupHooks 调用 webpack api 监听 compile的 done 事件，当编译完成，执行done钩子，调用_sendStats，在_sendStats方法中如果文件变化则发送hash。最后发送ok，客户端在接受到OK后会执行reload。</p>
<h4 id="client端源码"><a href="#client端源码" class="headerlink" title="client端源码"></a>client端源码</h4><p>客户端socket接受到hash后保存起来，随后接受到ok执行reload命令。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//Client/index.js</span>
<span class="token keyword">var</span> onSocketMessage <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  hash<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span>_hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//将hash保存到全局currentHash中</span>
    status<span class="token punctuation">.</span>currentHash <span class="token operator">=</span> _hash<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ok<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
      <span class="token comment" spellcheck="true">//执行更新的reloadApp函数</span>
    <span class="token function">reloadApp</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">socket</span><span class="token punctuation">(</span>socketUrl<span class="token punctuation">,</span> onSocketMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//Client/utils/reloadApp.js</span>
<span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span>_ref<span class="token punctuation">,</span> _ref2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//hotEmitter是events类，webpack-dev-server发布webpackHotUpdate给webapck</span>
    <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>\'webpack<span class="token operator">/</span>hot<span class="token operator">/</span>emitter\'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>\'webpackHotUpdate\'<span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> self <span class="token operator">!==</span> \'undefined\' <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span>window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// broadcast update to window</span>
      self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">"webpackHotUpdate"</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>currentHash<span class="token punctuation">)</span><span class="token punctuation">,</span> \'<span class="token operator">*</span>\'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>客户端接收到ok指令后，执行reloadApp函数。reloadApp函数中，hotEmitter其实是events模块的实例，即在全局实现发布订阅模式，hotEmitter发布了webpackHotUpdate事件，同时webpack订阅这个指令。</p>
<p>在这里以后，浏览器端进入webpack的代码，webpack-dev-server在客户端的部分完成。</p>
<p>订阅webpackHotUpdate事件的代码在webpack/hot/dev-server.js中:</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> lastHash<span class="token punctuation">;</span>
    <span class="token keyword">var</span> check <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        module<span class="token punctuation">.</span>hot
            <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>updatedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//检查所有要更新的模块，如果没有模块要更新那么回调函数就是null</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>updatedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">upToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//如果还有更新</span>
                    <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./emitter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"webpackHotUpdate"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>currentHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lastHash <span class="token operator">=</span> currentHash<span class="token punctuation">;</span>
        <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//调用check方法</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>module为全局对象，module.hot的代码在HMR runtime中，module.hot.check对应hotCheck方法：</p>
<pre class="line-numbers language-js"><code class="language-js">hotCheck <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//module.hot.check方法</span>
    <span class="token keyword">return</span> hotDownloadManifest<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token punctuation">{</span> 
        <span class="token comment" spellcheck="true">//保存全局的热更新信息</span>
        hotAvailableFilesMap <span class="token operator">=</span> update<span class="token punctuation">.</span>c<span class="token punctuation">;</span>
        hotUpdateNewHash <span class="token operator">=</span> update<span class="token punctuation">.</span>h<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*globals chunkId */</span>
        <span class="token function">hotEnsureUpdateChunk</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">hotDownloadManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//ajax请求模块manifest</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">hotEnsureUpdateChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//检测模块</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hotAvailableFilesMap<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> <span class="token keyword">else</span> 
    <span class="token punctuation">{</span>
        hotRequestedFilesMap<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">hotDownloadUpdateChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">hotDownloadUpdateChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//jsonp格式请求代码模块chunk</span>

<span class="token comment" spellcheck="true">//chunk是js代码块，格式是webpackHotUpdate("main", {...})，收到后直接执行，window全局中有对应方法</span>
window<span class="token punctuation">[</span><span class="token string">"webpackHotUpdate"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">function</span> <span class="token function">webpackHotUpdateCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">hotAddUpdateChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">hotAddUpdateChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//动态的更新代码模块</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//记录全局的热更新模块</span>
        hotUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">hotUpdateDownloaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">hotUpdateDownloaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//执行hotApply模块</span>
    <span class="token function">hotApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">hotApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//将代码更新到modules中</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要包含了两个请求，在hotDownloadManifest中客户端请求了ajax的manifest，他的格式为 <code>{&quot;h&quot;:&quot;bbff25e45ca71af784d0&quot;,&quot;c&quot;:{&quot;main&quot;:true}}</code> 包含了要更新模块的hash值和chunk名；另一个hotDownloadUpdateChunk通过jsonp方法请求更新的代码块，<br><img src="https://img.58cdn.com.cn/escstatic/fecar/pmuse/webpackhmr/down_200629164144.png" alt="hotDownloadUpdateChunk获取更新的代码"><br>获取到的代码块可以直接执行，webpack已经在window中注册了webpackHotUpdate方法，执行后调用hotApply热模块替换方法。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">hotApply</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">getAffectedStuff</span><span class="token punctuation">(</span>updateModuleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//返回过期的模块和依赖</span>
            type<span class="token punctuation">:</span> <span class="token string">"accepted"</span><span class="token punctuation">,</span>
            moduleId<span class="token punctuation">:</span> updateModuleId<span class="token punctuation">,</span>
            outdatedModules<span class="token punctuation">:</span> outdatedModules<span class="token punctuation">,</span>
            outdatedDependencies<span class="token punctuation">:</span> outdatedDependencies
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
                result <span class="token operator">=</span> <span class="token function">getAffectedStuff</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token string">"self-declined"</span><span class="token punctuation">:</span>
                    <span class="token operator">...</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token string">"accepted"</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>对结果进行标记及处理
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>onAccepted<span class="token punctuation">)</span> options<span class="token punctuation">.</span><span class="token function">onAccepted</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    doApply <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token string">"disposed"</span><span class="token punctuation">:</span>
                    <span class="token operator">...</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token punctuation">:</span>
                    <span class="token operator">...</span>
            <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        moduleId <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">...</span>
        <span class="token keyword">delete</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除过期的模块和依赖</span>
        <span class="token keyword">delete</span> outdatedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> appliedUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>appliedUpdate<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//新的模块添加到modules中</span>
            modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> appliedUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>模块热替换主要分三个部分，首先是找出 outdatedModules 和 outdatedDependencies；然后从缓存中删除这些；最后，将新的模块添加到 modules 中，当下次调用 <strong>webpack_require</strong> (webpack 重写的 require 方法)方法的时候，就是获取到了新的模块代码了。</p>
<p>如果在热更新过程中出现错误，热更新将回退到刷新浏览器。</p>
<p>当用新的模块代码替换老的模块后，但是我们的业务代码并不能知道代码已经发生变化，也就是说，当入口文件修改后，我们需要在入口文件中调用 HMR 的 accept 方法</p>
<pre><code>// index.js
if(module.hot) {
    module.hot.accept(\&#39;./main.js\&#39;, function() {
        render()
    })
}</code></pre><p>更新的代码每次在下面这个循环中执行， <code>cb(moduleOutdatedDependencies)</code><br>就是<code>module.hot.accept</code>的内容，从而实现对代码的渲染</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">hotApply</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> outdatedDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        moduleOutdatedDependencies <span class="token operator">=</span> outdatedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&amp;</span>lt<span class="token punctuation">;</span> moduleOutdatedDependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dependency <span class="token operator">=</span> moduleOutdatedDependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            cb <span class="token operator">=</span> module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>dependency<span class="token punctuation">]</span><span class="token punctuation">;</span>
            callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取所有的模块</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&amp;</span>lt<span class="token punctuation">;</span> callbacks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cb <span class="token operator">=</span> callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">cb</span><span class="token punctuation">(</span>moduleOutdatedDependencies<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//执行代码模块</span>
        <span class="token punctuation">}</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="手写webpack构建工具"><a href="#手写webpack构建工具" class="headerlink" title="手写webpack构建工具"></a>手写webpack构建工具</h2><h3 id="手写webpack流程"><a href="#手写webpack流程" class="headerlink" title="手写webpack流程"></a>手写webpack流程</h3><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3g62fknvj31ok0lq4a4.jpg" alt="image-20210128153623321"></p>
<h3 id="AST"><a href="#AST" class="headerlink" title="AST"></a>AST</h3><h4 id="AST-Abstract-Syntax-Tree"><a href="#AST-Abstract-Syntax-Tree" class="headerlink" title="AST(Abstract Syntax Tree)"></a>AST(Abstract Syntax Tree)</h4><p>抽象语法树，源代码语法结构的一种抽象表示</p>
<ul>
<li>以树状的形式表现编程语言的语法结构 </li>
<li>树上的每个节点都表示源代码中的一种结构</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3m52v4ghj31jk0l8ay2.jpg" alt="image-20210128190259694"></p>
<h4 id="AST生成过程"><a href="#AST生成过程" class="headerlink" title="AST生成过程"></a>AST生成过程</h4><p>抽象语法树的生成主要依靠的是Javascript Parser(js解析器)</p>
<ul>
<li>词法分析（Lexical Analysis） </li>
<li>语法分析（Parse Analysis）</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3m9baz2zj31lj0u0tzs.jpg" alt="image-20210128190704960"></p>
<h3 id="在手写webpack中使用"><a href="#在手写webpack中使用" class="headerlink" title="在手写webpack中使用"></a>在手写webpack中使用</h3><h4 id="通过Visitor完成依赖的收集"><a href="#通过Visitor完成依赖的收集" class="headerlink" title="通过Visitor完成依赖的收集"></a>通过Visitor完成依赖的收集</h4><p>访问者（visitor）是一个用于 AST 遍历的跨语言模式，定义 了用于在一个树状结构中获取具体节点的方法</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3mb7ry01j31k60cc4e0.jpg" alt="image-20210128190855377"></p>
<h4 id="树的宽度优先搜索（BFS）算法思想"><a href="#树的宽度优先搜索（BFS）算法思想" class="headerlink" title="树的宽度优先搜索（BFS）算法思想"></a>树的宽度优先搜索（BFS）算法思想</h4><p>应用于循环分析依赖   </p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3mbwtqejj31k20l8wxx.jpg" alt="image-20210128190936336"></p>
<h4 id="树的宽度优先搜索（BFS）算法思想-1"><a href="#树的宽度优先搜索（BFS）算法思想-1" class="headerlink" title="树的宽度优先搜索（BFS）算法思想"></a>树的宽度优先搜索（BFS）算法思想</h4><p>循环分析结果  </p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3mcxcbwkj31ee0ma1kx.jpg" alt="image-20210128191032396"></p>
<h4 id="打包结果为一个IIFE"><a href="#打包结果为一个IIFE" class="headerlink" title="打包结果为一个IIFE"></a>打包结果为一个IIFE</h4><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3mdeurxgj31ja0nwe11.jpg" alt="image-20210128191102224"></p>
<h4 id="打包结果分析"><a href="#打包结果分析" class="headerlink" title="打包结果分析"></a>打包结果分析</h4><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3mdxzohgj31m20pgwy8.jpg" alt="image-20210128191133160"></p>
<h4 id="结果运行分析"><a href="#结果运行分析" class="headerlink" title="结果运行分析"></a>结果运行分析</h4><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gn3mek1pz8j31lq0q07po.jpg" alt="image-20210128191208190"></p>
<h2 id="webpack构建优化"><a href="#webpack构建优化" class="headerlink" title="webpack构建优化"></a>webpack构建优化</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>如今前端工程化的概念早已经深入人心，选择一款合适的编译和资源管理工具已经成为了所有前端工程中的标配，而在诸多的构建工具中，webpack以其丰富的功能和灵活的配置而深受业内吹捧，逐步取代了grunt和gulp成为大多数前端工程实践中的首选，React，Vue，Angular等诸多知名项目也都相继选用其作为官方构建工具，极受业内追捧。但是，随者工程开发的复杂程度和代码规模不断地增加，webpack暴露出来的各种性能问题也愈发明显，极大的影响着开发过程中的体验。</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030107882.png" alt></p>
<h3 id="问题归纳"><a href="#问题归纳" class="headerlink" title="问题归纳"></a>问题归纳</h3><p>历经了多个web项目的实战检验，我们对webapck在构建中逐步暴露出来的性能问题归纳主要有如下几个方面：</p>
<p>代码全量构建速度过慢，即使是很小的改动，也要等待长时间才能查看到更新与编译后的结果（引入HMR热更新后有明显改进）；<br>随着项目业务的复杂度增加，工程模块的体积也会急剧增大，构建后的模块通常要以M为单位计算；<br>多个项目之间共用基础资源存在重复打包，基础库代码复用率不高；<br>node的单进程实现在耗cpu计算型loader中表现不佳；<br>针对以上的问题，我们来看看怎样利用webpack现有的一些机制和第三方扩展插件来逐个击破。</p>
<h3 id="慢在何处"><a href="#慢在何处" class="headerlink" title="慢在何处"></a>慢在何处</h3><p>作为工程师，我们一直鼓励要理性思考，用数据和事实说话，“我觉得很慢”，“太卡了”，“太大了”之类的表述难免显得太笼统和太抽象，那么我们不妨从如下几个方面来着手进行分析：</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030153413.png" alt></p>
<p>从项目结构着手，代码组织是否合理，依赖使用是否合理；<br>从webpack自身提供的优化手段着手，看看哪些api未做优化配置；<br>从webpack自身的不足着手，做有针对性的扩展优化，进一步提升效率；<br>在这里我们推荐使用一个wepback的可视化资源分析工具：webpack-bundle-analyzer，在webpack构建的时候会自动帮你计算出各个模块在你的项目工程中的依赖与分布情况，方便做更精确的资源依赖和引用的分析。</p>
<p>从上图中我们不难发现大多数的工程项目中，依赖库的体积永远是大头，通常体积可以占据整个工程项目的7-9成，而且在每次开发过程中也会重新读取和编译对应的依赖资源，这其实是很大的的资源开销浪费，而且对编译结果影响微乎其微，毕竟在实际业务开发中，我们很少会去主动修改第三方库中的源码，改进方案如下：</p>
<h3 id="方案一、合理配置-CommonsChunkPlugin"><a href="#方案一、合理配置-CommonsChunkPlugin" class="headerlink" title="方案一、合理配置 CommonsChunkPlugin"></a>方案一、合理配置 CommonsChunkPlugin</h3><p>webpack的资源入口通常是以entry为单元进行编译提取，那么当多entry共存的时候，CommonsChunkPlugin的作用就会发挥出来，对所有依赖的chunk进行公共部分的提取，但是在这里可能很多人会误认为抽取公共部分指的是能抽取某个代码片段，其实并非如此，它是以module为单位进行提取。</p>
<p>假设我们的页面中存在entry1，entry2，entry3三个入口，这些入口中可能都会引用如utils，loadash，fetch等这些通用模块，那么就可以考虑对这部分的共用部分机提取。通常提取方式有如下四种实现：</p>
<h4 id="1、传入字符串参数，由chunkplugin自动计算提取"><a href="#1、传入字符串参数，由chunkplugin自动计算提取" class="headerlink" title="1、传入字符串参数，由chunkplugin自动计算提取"></a>1、传入字符串参数，由chunkplugin自动计算提取</h4><pre><code>new webpack.optimize.CommonsChunkPlugin(&#39;common.js&#39;)</code></pre><p>这种做法默认会把所有入口节点的公共代码提取出来, 生成一个<code>common.js</code></p>
<h4 id="2、有选择的提取公共代码"><a href="#2、有选择的提取公共代码" class="headerlink" title="2、有选择的提取公共代码"></a>2、有选择的提取公共代码</h4><pre><code>new webpack.optimize.CommonsChunkPlugin(&#39;common.js&#39;,[&#39;entry1&#39;,&#39;entry2&#39;]);</code></pre><p>只提取<code>entry1</code>节点和<code>entry2</code>中的共用部分模块, 生成一个<code>common.js</code></p>
<h4 id="3、将entry下所有的模块的公共部分（可指定引用次数）提取到一个通用的chunk中"><a href="#3、将entry下所有的模块的公共部分（可指定引用次数）提取到一个通用的chunk中" class="headerlink" title="3、将entry下所有的模块的公共部分（可指定引用次数）提取到一个通用的chunk中"></a>3、将entry下所有的模块的公共部分（可指定引用次数）提取到一个通用的chunk中</h4><pre><code>new webpack.optimize.CommonsChunkPlugin({
    name: &#39;vendors&#39;,
    minChunks: function (module, count) {
       return (
          module.resource &amp;&amp;
          /\.js$/.test(module.resource) &amp;&amp;
          module.resource.indexOf(
            path.join(__dirname, &#39;../node_modules&#39;)
          ) === 0
       )
    }
});</code></pre><p>提取所有<code>node_modules</code>中的模块至<code>vendors</code>中，也可以指定<code>minChunks</code>中的最小引用数；</p>
<h4 id="4、抽取enry中的一些lib抽取到vendors中"><a href="#4、抽取enry中的一些lib抽取到vendors中" class="headerlink" title="4、抽取enry中的一些lib抽取到vendors中"></a>4、抽取enry中的一些lib抽取到vendors中</h4><pre><code>entry = {
    vendors: [&#39;fetch&#39;, &#39;loadash&#39;]
};
new webpack.optimize.CommonsChunkPlugin({
    name: &quot;vendors&quot;,
    minChunks: Infinity
});</code></pre><p>添加一个<code>entry</code>名叫为<code>vendors</code>，并把<code>vendors</code>设置为所需要的资源库，<code>CommonsChunk</code>会自动提取指定库至<code>vendors</code>中。</p>
<h3 id="方案二、通过-externals-配置来提取常用库"><a href="#方案二、通过-externals-配置来提取常用库" class="headerlink" title="方案二、通过 externals 配置来提取常用库"></a>方案二、通过 externals 配置来提取常用库</h3><p>在实际项目开发过程中，我们并不需要实时调试各种库的源码，这时候就可以考虑使用external选项了。</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030313974.jpeg" alt></p>
<p>简单来说external就是把我们的依赖资源声明为一个外部依赖，然后通过script外链脚本引入。这也是我们早期页面开发中资源引入的一种翻版，只是通过配置后可以告知webapck遇到此类变量名时就可以不用解析和编译至模块的内部文件中，而改用从外部变量中读取，这样能极大的提升编译速度，同时也能更好的利用CDN来实现缓存。</p>
<p>external的配置相对比较简单，只需要完成如下三步：</p>
<h4 id="1、在页面中加入需要引入的lib地址，如下："><a href="#1、在页面中加入需要引入的lib地址，如下：" class="headerlink" title="1、在页面中加入需要引入的lib地址，如下："></a>1、在页面中加入需要引入的lib地址，如下：</h4><pre><code>&lt;head&gt;
&lt;script src=&quot;//cdn.bootcss.com/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;//cdn.bootcss.com/underscore.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/static/common/react.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/static/common/react-dom.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/static/common/react-router.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/static/common/immutable.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;</code></pre><h4 id="2、在webapck-config-js中加入external配置项："><a href="#2、在webapck-config-js中加入external配置项：" class="headerlink" title="2、在webapck.config.js中加入external配置项："></a>2、在webapck.config.js中加入external配置项：</h4><pre><code>module.export = {
    externals: {
        &#39;react-router&#39;: {
            amd: &#39;react-router&#39;,
            root: &#39;ReactRouter&#39;,
            commonjs: &#39;react-router&#39;,
            commonjs2: &#39;react-router&#39;
        },
        react: {
            amd: &#39;react&#39;,
            root: &#39;React&#39;,
            commonjs: &#39;react&#39;,
            commonjs2: &#39;react&#39;
        },
        &#39;react-dom&#39;: {
            amd: &#39;react-dom&#39;,
            root: &#39;ReactDOM&#39;,
            commonjs: &#39;react-dom&#39;,
            commonjs2: &#39;react-dom&#39;
        }
    }
}</code></pre><p>这里要提到的一个细节是：此类文件在配置前，构建这些资源包时需要采用<code>amd/commonjs/cmd</code>相关的模块化进行兼容封装，即打包好的库已经是umd模式包装过的，如在<code>node_modules/react-router</code>中我们可以看到umd/ReactRouter.js之类的文件，只有这样<code>webpack</code>中的<code>require</code>和<code>import * from &#39;xxxx&#39;</code>才能正确读到该类包的引用，在这类js的头部一般也能看到如下字样：</p>
<p>if (typeof exports === ‘object’ &amp;&amp; typeof module === ‘object’) {<br>    module.exports = factory(require(“react”));<br>} else if (typeof define === ‘function’ &amp;&amp; define.amd) {<br>    define([“react”], factory);<br>} else if (typeof exports === ‘object’) {<br>    exports[“ReactRouter”] = factory(require(“react”));<br>} else {<br>    root[“ReactRouter”] = factory(root[“React”]);<br>}</p>
<h4 id="3、非常重要的是一定要在output选项中加入如下一句话："><a href="#3、非常重要的是一定要在output选项中加入如下一句话：" class="headerlink" title="3、非常重要的是一定要在output选项中加入如下一句话："></a>3、非常重要的是一定要在output选项中加入如下一句话：</h4><pre><code>output: {
  libraryTarget: &#39;umd&#39;
}</code></pre><p>由于通过<code>external</code>提取过的js模块是不会被记录到<code>webapck</code>的<code>chunk</code>信息中，通过libraryTarget可告知我们构建出来的业务模块，当读到了externals中的key时，需要以<code>umd</code>的方式去获取资源名，否则会有出现找不到module的情况。</p>
<p>通过配置后，我们可以看到对应的资源信息已经可以在浏览器的<code>source map</code>中读到了。</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030426901.png" alt></p>
<p>对应的资源也可以直接由页面外链载入，有效地减小了资源包的体积。</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030454254.jpeg" alt></p>
<h3 id="方案三、利用-DllPlugin-和-DllReferencePlugin-预编译资源模块"><a href="#方案三、利用-DllPlugin-和-DllReferencePlugin-预编译资源模块" class="headerlink" title="方案三、利用 DllPlugin 和 DllReferencePlugin 预编译资源模块"></a>方案三、利用 DllPlugin 和 DllReferencePlugin 预编译资源模块</h3><p>我们的项目依赖中通常会引用大量的npm包，而这些包在正常的开发过程中并不会进行修改，但是在每一次构建过程中却需要反复的将其解析，如何来规避此类损耗呢？这两个插件就是干这个用的。</p>
<p>简单来说DllPlugin的作用是预先编译一些模块，而DllReferencePlugin则是把这些预先编译好的模块引用起来。这边需要注意的是DllPlugin必须要在DllReferencePlugin执行前先执行一次，dll这个概念应该也是借鉴了windows程序开发中的dll文件的设计理念。</p>
<p>相对于<code>externals，dllPlugin</code>有如下几点优势：</p>
<ul>
<li>dll预编译出来的模块可以作为静态资源链接库可被重复使用，尤其适合多个项目之间的资源共享，如同一个站点pc和手机版等；</li>
<li>dll资源能有效地解决资源循环依赖的问题，部分依赖库如：<code>react-addons-css-transition-group</code>这种原先从react核心库中抽取的资源包，整个代码只有一句话：</li>
</ul>
<pre><code>module.exports = require(&#39;react/lib/ReactCSSTransitionGroup&#39;);</code></pre><p>却因为重新指向了react/lib中，这也会导致在通过externals引入的资源只能识别react,寻址解析react/lib则会出现无法被正确索引的情况。</p>
<ul>
<li>由于externals的配置项需要对每个依赖库进行逐个定制，所以每次增加一个组件都需要手动修改，略微繁琐，而通过dllPlugin则能完全通过配置读取，减少维护的成本；</li>
</ul>
<h4 id="1、配置dllPlugin对应资源表并编译文件"><a href="#1、配置dllPlugin对应资源表并编译文件" class="headerlink" title="1、配置dllPlugin对应资源表并编译文件"></a>1、配置dllPlugin对应资源表并编译文件</h4><p>那么externals该如何使用呢，其实只需要增加一个配置文件：<code>webpack.dll.config.js</code>：</p>
<pre><code>const webpack = require(&#39;webpack&#39;);
const path = require(&#39;path&#39;);
const isDebug = process.env.NODE_ENV === &#39;development&#39;;
const outputPath = isDebug ? path.join(__dirname, &#39;../common/debug&#39;) : path.join(__dirname, &#39;../common/dist&#39;);
const fileName = &#39;[name].js&#39;;

// 资源依赖包，提前编译
const lib = [
  &#39;react&#39;,
  &#39;react-dom&#39;,
  &#39;react-router&#39;,
  &#39;history&#39;,
  &#39;react-addons-pure-render-mixin&#39;,
  &#39;react-addons-css-transition-group&#39;,
  &#39;redux&#39;,
  &#39;react-redux&#39;,
  &#39;react-router-redux&#39;,
  &#39;redux-actions&#39;,
  &#39;redux-thunk&#39;,
  &#39;immutable&#39;,
  &#39;whatwg-fetch&#39;,
  &#39;byted-people-react-select&#39;,
  &#39;byted-people-reqwest&#39;
];

const plugin = [
  new webpack.DllPlugin({
    /**
     * path
     * 定义 manifest 文件生成的位置
     * [name]的部分由entry的名字替换
     */
    path: path.join(outputPath, &#39;manifest.json&#39;),
    /**
     * name
     * dll bundle 输出到那个全局变量上
     * 和 output.library 一样即可。
     */
    name: &#39;[name]&#39;,
    context: __dirname
  }),
  new webpack.optimize.OccurenceOrderPlugin()
];

if (!isDebug) {
  plugin.push(
    new webpack.DefinePlugin({
      &#39;process.env.NODE_ENV&#39;: JSON.stringify(&#39;production&#39;)
    }),
    new webpack.optimize.UglifyJsPlugin({
      mangle: {
        except: [&#39;$&#39;, &#39;exports&#39;, &#39;require&#39;]
      },
      compress: { warnings: false },
      output: { comments: false }
    })
  )
}

module.exports = {
  devtool: &#39;#source-map&#39;,
  entry: {
    lib: lib
  },
  output: {
    path: outputPath,
    filename: fileName,
    /**
     * output.library
     * 将会定义为 window.${output.library}
     * 在这次的例子中，将会定义为`window.vendor_library`
     */
    library: &#39;[name]&#39;,
    libraryTarget: &#39;umd&#39;,
    umdNamedDefine: true
  },
  plugins: plugin
};</code></pre><p>然后执行命令：</p>
<pre><code>$ NODE_ENV=development webpack --config  webpack.dll.lib.js --progress
$ NODE_ENV=production webpack --config  webpack.dll.lib.js --progress </code></pre><p>即可分别编译出支持调试版和生产环境中lib静态资源库，在构建出来的文件中我们也可以看到会自动生成如下资源：</p>
<pre><code>common
├── debug
 │   ├── lib.js
 │   ├── lib.js.map
 │   └── manifest.json
└── dist
    ├── lib.js
    ├── lib.js.map
    └── manifest.json</code></pre><p>文件说明：</p>
<p>lib.js可以作为编译好的静态资源文件直接在页面中通过src链接引入，与externals的资源引入方式一样，生产与开发环境可以通过类似charles之类的代理转发工具来做路由替换；<br>manifest.json中保存了webpack中的预编译信息，这样等于提前拿到了依赖库中的chunk信息，在实际开发过程中就无需要进行重复编译；</p>
<h4 id="2、dllPlugin的静态资源引入"><a href="#2、dllPlugin的静态资源引入" class="headerlink" title="2、dllPlugin的静态资源引入"></a>2、dllPlugin的静态资源引入</h4><p>lib.js和manifest.json存在一一对应的关系，所以我们在调用的过程也许遵循这个原则，如当前处于开发阶段，对应我们可以引入common/debug文件夹下的lib.js和manifest.json，切换到生产环境的时候则需要引入common/dist下的资源进行对应操作，这里考虑到手动切换和维护的成本，我们推荐使用add-asset-html-webpack-plugin进行依赖资源的注入，可得到如下结果：</p>
<pre><code>&lt;head&gt;
&lt;script src=&quot;/static/common/lib.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
在webpack.config.js文件中增加如下代码：

const isDebug = (process.env.NODE_ENV === &#39;development&#39;);
const libPath = isDebug ? &#39;../dll/lib/manifest.json&#39; : 
&#39;../dll/dist/lib/manifest.json&#39;;

// 将mainfest.json添加到webpack的构建中

module.export = {
  plugins: [
       new webpack.DllReferencePlugin({
       context: __dirname,
       manifest: require(libPath),
      })
  ]
}</code></pre><p>配置完成后我们能发现对应的资源包已经完成了纯业务模块的提取</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030700114.png" alt></p>
<p>多个工程之间如果需要使用共同的lib资源，也只需要引入对应的lib.js和manifest.js即可，plugin配置中也支持多个<code>webpack.DllReferencePlugin</code>同时引入使用，如下：</p>
<pre><code>module.export = {
  plugins: [
     new webpack.DllReferencePlugin({
        context: __dirname,
        manifest: require(libPath),
      }),
      new webpack.DllReferencePlugin({
        context: __dirname,
        manifest: require(ChartsPath),
      })
  ]</code></pre><h3 id="方案四、使用-Happypack-加速你的代码构建"><a href="#方案四、使用-Happypack-加速你的代码构建" class="headerlink" title="方案四、使用 Happypack 加速你的代码构建"></a>方案四、使用 Happypack 加速你的代码构建</h3><p>以上介绍均为针对webpack中的chunk计算和编译内容的优化与改进，对资源的实际体积改进上也较为明显，那么除此之外，我们能否针对资源的编译过程和速度优化上做些尝试呢？</p>
<p>众所周知，webpack中为了方便各种资源和类型的加载，设计了以loader加载器的形式读取资源，但是受限于node的编程模型影响，所有的loader虽然以async的形式来并发调用，但是还是运行在单个 node的进程以及在同一个事件循环中，这就直接导致了当我们需要同时读取多个loader文件资源时，比如babel-loader需要transform各种jsx，es6的资源文件。在这种同步计算同时需要大量耗费cpu运算的过程中，node的单进程模型就无优势了，那么happypack就针对解决此类问题而生。</p>
<h4 id="开启happypack的线程池"><a href="#开启happypack的线程池" class="headerlink" title="开启happypack的线程池"></a>开启happypack的线程池</h4><p>happypack的处理思路是将原有的webpack对loader的执行过程从单一进程的形式扩展多进程模式，原本的流程保持不变，这样可以在不修改原有配置的基础上来完成对编译过程的优化，具体配置如下：</p>
<pre><code> const HappyPack = require(&#39;happypack&#39;);
 const os = require(&#39;os&#39;)
 const HappyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length}); // 启动线程池});

module:{
    rules: [
      {
        test: /\.(js|jsx)$/,
        // use: [&#39;babel-loader?cacheDirectory&#39;],
        use: &#39;happypack/loader?id=jsx&#39;,
        exclude: /^node_modules$/
      }
    ]
  },
  plugins:[
    new HappyPack({
     id: &#39;jsx&#39;,
     cache: true,
     threadPool: HappyThreadPool,
     loaders: [&#39;babel-loader&#39;]
   })
  ]</code></pre><p>我们可以看到通过在loader中配置直接指向happypack提供的loader，对于文件实际匹配的处理 loader，则是通过配置在plugin属性来传递说明，这里happypack提供的loader与plugin的衔接匹配，则是通过<code>id=happybabel</code>来完成。配置完成后，laoder的工作模式就转变成了如下所示：</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030795462.png" alt></p>
<p>happypack在编译过程中除了利用多进程的模式加速编译，还同时开启了cache计算，能充分利用缓存读取构建文件，对构建的速度提升也是非常明显的，经过测试，最终的构建速度提升如下：</p>
<p>优化前：</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030827234.png" alt></p>
<p>优化后：</p>
<p><img src="https://img.58cdn.com.cn/escstatic/docs/images/1576030853961.png" alt></p>
<p>关于happyoack的更多介绍可以查看：</p>
<p><a href>happypack</a><br>｜<br><a href>happypack 原理解析</a></p>
<h3 id="方案五、增强-uglifyPlugin"><a href="#方案五、增强-uglifyPlugin" class="headerlink" title="方案五、增强 uglifyPlugin"></a>方案五、增强 uglifyPlugin</h3><p>uglifyJS凭借基于node开发，压缩比例高，使用方便等诸多优点已经成为了js压缩工具中的首选，但是我们在webpack的构建中观察发现，当webpack build进度走到80%前后时，会发生很长一段时间的停滞，经测试对比发现这一过程正是uglfiyJS在对我们的output中的bunlde部分进行压缩耗时过长导致，针对这块我们可以使用webpack-uglify-parallel来提升压缩速度。</p>
<p>从插件源码中可以看到，webpack-uglify-parallel的是实现原理是采用了多核并行压缩的方式来提升我们的压缩速度。</p>
<pre><code>plugin.nextWorker().send({
    input: input,
    inputSourceMap: inputSourceMap,
    file: file,
    options: options
});

plugin._queue_len++;

if (!plugin._queue_len) {
    callback();
}               

if (this.workers.length &lt; this.maxWorkers) {
    var worker = fork(__dirname + &#39;/lib/worker&#39;);
    worker.on(&#39;message&#39;, this.onWorkerMessage.bind(this));
    worker.on(&#39;error&#39;, this.onWorkerError.bind(this));
    this.workers.push(worker);
}

this._next_worker++;
return this.workers[this._next_worker % this.maxWorkers];</code></pre><p>使用配置也非常简单，只需要将我们原来webpack中自带的uglifyPlugin配置：</p>
<pre><code>new webpack.optimize.UglifyJsPlugin({
   exclude:/\.min\.js$/
   mangle:true,
   compress: { warnings: false },
   output: { comments: false }
})
修改成如下代码即可：

const os = require(&#39;os&#39;);
    const UglifyJsParallelPlugin = require(&#39;webpack-uglify-parallel&#39;);

    new UglifyJsParallelPlugin({
      workers: os.cpus().length,
      mangle: true,
      compressor: {
        warnings: false,
        drop_console: true,
        drop_debugger: true
       }
    })</code></pre><p>目前webpack官方也维护了一个支持多核压缩的UglifyJs插件：uglifyjs-webpack-plugin,使用方式类似，优势在于完全兼容webpack.optimize.UglifyJsPlugin中的配置，可以通过uglifyOptions写入，因此也做为推荐使用，参考配置如下：</p>
<pre><code> const UglifyJsPlugin = require(&#39;uglifyjs-webpack-plugin&#39;);
  new UglifyJsPlugin({
    uglifyOptions: {
      ie8: false,
      ecma: 8,
      mangle: true,
      output: { comments: false },
      compress: { warnings: false }
    },
    sourceMap: false,
    cache: true,
    parallel: os.cpus().length * 2
  })</code></pre><h3 id="方案六、Tree-shaking-amp-Scope-Hoisting"><a href="#方案六、Tree-shaking-amp-Scope-Hoisting" class="headerlink" title="方案六、Tree-shaking &amp; Scope Hoisting"></a>方案六、Tree-shaking &amp; Scope Hoisting</h3><p>wepback在2.X和3.X中从rolluo中借鉴了tree-shaking和Scope Hoisting，利用es6的module特性，利用AST对所有引用的模块和方法做了静态分析，从而能有效地剔除项目中的没有引用到的方法，并将相关方法调用归纳到了独立的webpack_module中，对打包构建的体积优化也较为明显，但是前提是所有的模块写法必须使用ES6 Module进行实现，具体配置参考如下：</p>
<pre><code> // .babelrc: 通过配置减少没有引用到的方法
  {
    &quot;presets&quot;: [
      [&quot;env&quot;, {
        &quot;targets&quot;: {
          &quot;browsers&quot;: [&quot;last 2 versions&quot;, &quot;safari &gt;= 7&quot;]
        }
      }],
      // https://www.zhihu.com/question/41922432
      [&quot;es2015&quot;, {&quot;modules&quot;: false}]  // tree-shaking
    ]
  }

  // webpack.config: Scope Hoisting
  {
    plugins:[
      // https://zhuanlan.zhihu.com/p/27980441
      new webpack.optimize.ModuleConcatenationPlugin()
    ]
  }</code></pre><h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><p>在实际的开发过程中，可灵活地选择适合自身业务场景的优化手段。</p>
<table>
<thead>
<tr>
<th>优化手段</th>
<th>开发环境</th>
<th>生产环境</th>
</tr>
</thead>
<tbody><tr>
<td>CommonsChunk</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>externals</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>DllPlugin</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Happypack</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>uglify-parallel</td>
<td></td>
<td>√</td>
</tr>
</tbody></table>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《webpack浅入深出》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/02/02/webpack浅入深出/" property="cc:attributionName"
               rel="cc:attributionURL">
                浅夏晴空
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'de8dfcea77a9e87de17a',
        clientSecret: '569b91fd16e2f3972943f6907219b5ca2984aa1b',
        repo: 'gongchenghuigch.github.io',
        owner: 'gongchenghuigch',
        admin: "gongchenghuigch",
        id: '2021-02-02T17-30-39',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>
    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/02/02/Chrome实用插件整理/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Chrome实用插件整理">
                        
                        <span class="card-title">Chrome实用插件整理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            FEHelper简介本插件支持Chrome、Firefox、MS-Edge浏览器，内部工具集持续增加，目前包括 JSON自动/手动格式化、JSON内容比对、代码美化与压缩、信息编解码转换、二维码生成与解码、图片Base64编解码转换、Mar
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-02-02
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/工具类/" class="post-category" target="_blank">
                                    工具类
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Chrome/" target="_blank">
                        <span class="chip bg-color">Chrome</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/02/02/跨平台技术对比/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="跨平台技术对比">
                        
                        <span class="card-title">跨平台技术对比</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            跨平台技术发展的三个阶段
第一阶段是混合开发的web容器时代

为了解决原生开发的高成本、低效率，出现了Hybrid混合开发
原生中嵌入依托于浏览器的WebView
Web浏览器中可以实现的需求在WebView中基本都可以实现
但是Web最
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-02-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/大前端/" class="post-category" target="_blank">
                                    大前端
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/flutter/" target="_blank">
                        <span class="chip bg-color">flutter</span>
                    </a>
                    
                    <a href="/tags/ReactNative/" target="_blank">
                        <span class="chip bg-color">ReactNative</span>
                    </a>
                    
                    <a href="/tags/Hybrid/" target="_blank">
                        <span class="chip bg-color">Hybrid</span>
                    </a>
                    
                    <a href="/tags/Weex/" target="_blank">
                        <span class="chip bg-color">Weex</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            <span id="sitetime"></span> <br>
            本站由&copy;<a href="https://gongchenghuigch.github.io/" target="_blank">gongchenghui</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">214.1k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:gongch0719@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1134929850" class="tooltipped" data-tooltip="QQ联系我: 1134929850" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>
<script language = javascript >
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        var t1 = Date.UTC(2018, 08, 11, 00, 00, 00); //北京时间2018-2-13 00:00:00 
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond); 
        var diff = t2 - t1; var diffYears = Math.floor(diff / years); 
        var diffDays = Math.floor((diff / days) - diffYears * 365); 
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours); 
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes); 
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds); document.getElementById("sitetime").innerHTML = "本站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒"; 
    } 
	siteTime(); 
</script>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->



    <script src="/libs/others/clicklove.js"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>